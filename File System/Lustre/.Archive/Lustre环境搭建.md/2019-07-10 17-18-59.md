date: 2019-07-09 17:15
app: markdown
layout: 'post'
title: 'Lustre环境搭建——基于CentOS'
tags: Lustre


# 1.前言
Lustre文件系统的介绍暂时掠过，后面我会专门用一个主题来介绍Lustre文件系统。  
本文默认读者已经了解Lustre文件系统的架构，因此这里主要讲述如何从零搭建一套可用的Lustre环境。  

硬件配置: 
- 2个MDS节点(每个MDS节点配置2个MDT)
- 4个OSS节点(每个OSS节点配置4个OST)

Lustre环境搭建主要分为两个部分：
- 1、准备软件环境 
- 2、格式化文件系统

# 2.准备软件环境
- Lustre版本 2.10.3-基于IB
- CentOS 7.4.1708  
- OFED驱动版本 4.2-1.2.0.0

## 2.1 准备操作系统
### 2.1.1 关闭SELINUX
```bash
vim /etc/sysconfig/selinux 
修改相应字段
SELINUX=disabled
```
### 2.1.2 关闭防火墙
```bash
systemctl stop firewalld.service
systemctl disable firewalld.service
```
### 2.1.3 同步时钟
```bash
timedatectl set-timezone Asia/Shanghai
```

## 2.2  升级Kernel
### 2.2.1 安装依赖
```bash
yum -y install net-tools vim epel-release xmlto asciidoc elfutils-libelf-devel zlib-devel binutils-devel newt-devel python-devel hmaccalc perl-ExtUtils-Embed bison elfutils-devel audit-libs-devel python-docutils sg3_utils expect attr lsof quilt libselinux-devel libtool linux-firmware xfsprogs kmod libyaml libyaml-devel
```

### 2.2.2 替换kernel rpm包
```bash
rpm -Uvh kernel-tools-libs-3.10.0-693.11.6.el7_lustre.x86_64.rpm kernel-tools-3.10.0-693.11.6.el7_lustre.x86_64.rpm kernel-tools-libs-devel-3.10.0-693.11.6.el7_lustre.x86_64.rpm
rpm -Uvh kernel-headers-3.10.0-693.11.6.el7_lustre.x86_64.rpm kernel-devel-3.10.0-693.11.6.el7_lustre.x86_64.rpm kernel-3.10.0-693.11.6.el7_lustre.x86_64.rpm
```
> rpm包下载地址: https://downloads.whamcloud.com/public/lustre/lustre-2.10.3-ib/MOFED-4.2-1.2.0.0/el7.4.1708/server/RPMS/x86_64/
> 这个包是社区编译好的，可以直接替换

>  安装完后执行下面命令，确定内核是否已经更新: grub2-editenv list
```bash
[root@~]# grub2-editenv list
saved_entry=CentOS Linux (3.10.0-693.11.6.el7_lustre.x86_64) 7 (Core)
说明内核已经更新完成
```
>  更换完毕，重启服务器使内核生效  

## 2.3 安装IB驱动
### 2.3.1 安装依赖
```bash
yum -y install pciutils gtk2 atk cairo libxml2-python tcsh libnl lsof tcl tk createrepo gcc-gfortran gcc createrepo libyaml libyaml-devel
```
>  这里列出了基本的依赖，如果有缺少，按照指示安装即可

### 2.3.2 编译IB驱动
从MLNX官方下载IB驱动，本文使用的是MLNX_OFED_LINUX-4.2-1.2.0.0-rhel7.4-x86_64
- 解压IB驱动包
- 进入目录
- 编译安装驱动
```bash
./mlnxofedinstall --without-fw-update --add-kernel-support
```
>  如果缺少依赖，这里会报错，根据提示安装即可。

- 检查IB驱动版本
```bash
[root@ ~]# hca_self_test.ofed
Host Driver Version .................... MLNX_OFED_LINUX-4.5-1.0.1.0 (OFED-4.5-1.0.1): 3.10.0-693.11.6.el7_lustre.x86_64

[root@ ~]# ofed_info -s
MLNX_OFED_LINUX-4.5-1.0.1.0:
```
> 上面两种方法均可检查版本

- 重启IB服务，使其生效
```bash
/etc/init.d/openibd restart
```
- 配置ipoib地址
```bash
修改: /etc/sysconfig/network-scripts/ifcfg-ib0
```

## 2.4 安装Lustre相关rpm包
### 2.4.1 安装e2fsprogs相关包
rpm包下载地址: https://downloads.whamcloud.com/public/e2fsprogs/latest/el7/RPMS/x86_64/

执行下面的安装命令:
```bash
rpm -Uvh e2fsprogs-*.rpm libcom_err-*.rpm libss-*.rpm
```

### 2.4.2 安装Lustre Server
rpm包下载地址: https://downloads.whamcloud.com/public/lustre/lustre-2.10.3-ib/MOFED-4.2-1.2.0.0/el7.4.1708/server/RPMS/x86_64/

执行下面的安装命令:
```bash
rpm -Uvh lustre-osd-ldiskfs-mount-2.10.3-1.el7.x86_64.rpm kmod-lustre-2.10.3-1.el7.x86_64.rpm kmod-lustre-osd-ldiskfs-2.10.3-1.el7.x86_64.rpm lustre-2.10.3-1.el7.x86_64.rpm
```

## 2.5 启动Lustre模块
### 2.5.1 写lustre.conf文件
在lustre.conf文件中指定lnet使用的网络类型
- 使用IB的方式
```bash
vim /etc/modprobe.d/lustre.conf
options lnet networks=o2ib(ib0)
```
- 使用TCP的方式
```bash
vim /etc/modprobe.d/lustre.conf
options lnet networks=tcp(eth0)
```
- 二者同时使用
```ba

```

# 3.格式化文件系统
