date: 2019-07-24 17:15
app: markdown
layout: 'post'
title: 'Lustre故障跟踪之nrs_tbf_rule_match'
tags: Lustre

最近半年总是遇到一个bug，导致Lustre MDS节点发生crash，这篇文章主要是分析这个bug产生的原因及如何定位

先上日志：
```bash
[1139547.817517] LustreError: 20086:0:(nrs_tbf.c:235:nrs_tbf_rule_match()) ASSERTION( (tmp_rule->tr_flags & 0x0000001) == 0 ) failed:
[1139547.817540] LustreError: 20086:0:(nrs_tbf.c:235:nrs_tbf_rule_match()) LBUG
[1139547.817544] Pid: 20086, comm: mdt00_068
[1139547.817547]
Call Trace:
[1139547.817586]  [<ffffffffc09d57ae>] libcfs_call_trace+0x4e/0x60 [libcfs]
[1139547.817602]  [<ffffffffc09d583c>] lbug_with_loc+0x4c/0xb0 [libcfs]
[1139547.817700]  [<ffffffffc0f804c5>] nrs_tbf_rule_match+0xc5/0xd0 [ptlrpc]
[1139547.817780]  [<ffffffffc0f834ad>] nrs_tbf_res_get+0xad/0x4c0 [ptlrpc]
[1139547.817852]  [<ffffffffc0f7621c>] nrs_resource_get+0x7c/0x100 [ptlrpc]
[1139547.817922]  [<ffffffffc0f76790>] nrs_resource_get_safe+0x80/0xf0 [ptlrpc]
[1139547.817993]  [<ffffffffc0f7a263>] ptlrpc_nrs_req_initialize+0x83/0x100 [ptlrpc]
[1139547.818059]  [<ffffffffc0f48f31>] ptlrpc_main+0x1771/0x1e40 [ptlrpc]
[1139547.818125]  [<ffffffffc0f477c0>] ? ptlrpc_main+0x0/0x1e40 [ptlrpc]
[1139547.818134]  [<ffffffff810b252f>] kthread+0xcf/0xe0
[1139547.818141]  [<ffffffff810b2460>] ? kthread+0x0/0xe0
[1139547.818149]  [<ffffffff816b8798>] ret_from_fork+0x58/0x90
[1139547.818155]  [<ffffffff810b2460>] ? kthread+0x0/0xe0
[1139547.818159]
[1139547.818162] Kernel panic - not syncing: LBUG
[1139547.818212] CPU: 16 PID: 20086 Comm: mdt00_068 Tainted: G           OEL ------------   3.10.0-693.11.6.el7_lustre.x86_64 #1
[1139547.818355] Call Trace:
[1139547.818385]  [<ffffffff816a5e7d>] dump_stack+0x19/0x1b
[1139547.818433]  [<ffffffff8169fd64>] panic+0xe8/0x20d
[1139547.818492]  [<ffffffffc09d5854>] lbug_with_loc+0x64/0xb0 [libcfs]
[1139547.818611]  [<ffffffffc0f804c5>] nrs_tbf_rule_match+0xc5/0xd0 [ptlrpc]
[1139547.818732]  [<ffffffffc0f834ad>] nrs_tbf_res_get+0xad/0x4c0 [ptlrpc]
[1139547.818848]  [<ffffffffc0f7621c>] nrs_resource_get+0x7c/0x100 [ptlrpc]
[1139547.818965]  [<ffffffffc0f76790>] nrs_resource_get_safe+0x80/0xf0 [ptlrpc]
[1139547.819084]  [<ffffffffc0f7a263>] ptlrpc_nrs_req_initialize+0x83/0x100 [ptlrpc]
[1139547.819203]  [<ffffffffc0f48f31>] ptlrpc_main+0x1771/0x1e40 [ptlrpc]
[1139547.819316]  [<ffffffffc0f477c0>] ? ptlrpc_register_service+0xe30/0xe30 [ptlrpc]
[1139547.819376]  [<ffffffff810b252f>] kthread+0xcf/0xe0
[1139547.819419]  [<ffffffff810b2460>] ? insert_kthread_work+0x40/0x40
[1139547.819470]  [<ffffffff816b8798>] ret_from_fork+0x58/0x90
[1139547.819516]  [<ffffffff810b2460>] ? insert_kthread_work+0x40/0x40
```
Lustre version: 2.10.3
Kernel version 3.10.693.11.6_lustre
OFED: MLNX_OFED_LINUX-4.2-1.2.0.0

机器在发生crash时产生了vmcore文件，在/var/crash目录中，因此后面的分析主要是针对/var/crash目录中的kdump文件进行

# 1、配置vmcore文件解析环境
如何分析vmcore这个文件？
- 需要vmlinux
- 需要crash工具

具体来说，需要以下三个步骤：
1、安装kernel debuginfo，对于我的机器来说，对应debuginfo包是:
```bash
kernel-debuginfo-3.10.0-693.11.6.el7_lustre.x86_64.rpm
kernel-debuginfo-common-x86_64-3.10.0-693.11.6.el7_lustre.x86_64.rpm
```

2、安装crash工具以及debuginfo包
```bash
crash-7.1.9-2.el7.x86_64.rpm
crash-debuginfo-7.1.9-2.el7.x86_64.rpm
```

3、查询vmlinux路径
```bash
[root@mds01 ]# find / -name vmlinux
/usr/lib/debug/usr/lib/modules/3.10.0-693.11.6.el7_lustre.x86_64/vmlinux
```
接下来就可以执行cras

# 2、